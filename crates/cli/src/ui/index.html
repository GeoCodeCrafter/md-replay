<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>md-replay</title>
  <style>
    :root {
      --bg: #0a1119;
      --panel: #101a25;
      --panel2: #142233;
      --line: #25374b;
      --text: #e8eef7;
      --muted: #9fb0c4;
      --up: #4de08e;
      --down: #ff6a6a;
      --mid: #57b7ff;
      --spread: #ffd166;
      --imb: #b38dff;
      --vol: #ff9d5c;
      --accent: #2f8cf0;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      color: var(--text);
      font-family: "IBM Plex Sans", "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at 10% 18%, #1a355a 0, transparent 36%),
        radial-gradient(circle at 88% 0%, #195c59 0, transparent 44%),
        var(--bg);
      min-height: 100vh;
    }
    .app {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      display: grid;
      gap: 14px;
    }
    .title {
      font-size: 34px;
      font-weight: 650;
      margin: 0;
      letter-spacing: 0.3px;
    }
    .sub {
      color: var(--muted);
      margin-top: 4px;
      font-size: 13px;
    }
    .panel {
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 14px 35px rgba(0, 0, 0, 0.28);
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 8px;
    }
    .stat {
      border: 1px solid var(--line);
      border-radius: 9px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.02);
    }
    .label {
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 11px;
    }
    .value {
      margin-top: 5px;
      font-size: 20px;
      font-weight: 650;
      font-variant-numeric: tabular-nums;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .controls {
      display: grid;
      grid-template-columns: 1.1fr 1fr 1fr 1fr 0.8fr;
      gap: 8px;
      align-items: end;
    }
    .play {
      margin-top: 10px;
      display: grid;
      grid-template-columns: 0.8fr 0.8fr 0.8fr 0.8fr 1fr 1fr;
      gap: 8px;
      align-items: end;
    }
    .field label {
      display: block;
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 4px;
    }
    input, select, button {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 8px;
      background: #0d1621;
      color: var(--text);
      padding: 10px;
      font-size: 14px;
    }
    button {
      border: none;
      cursor: pointer;
      font-weight: 650;
      background: linear-gradient(180deg, #1e70c9, #16579b);
    }
    button:hover { filter: brightness(1.07); }
    button.alt {
      background: linear-gradient(180deg, #37485d, #2a384b);
    }
    button.warn {
      background: linear-gradient(180deg, #8b3f3f, #6f3131);
    }
    .mono {
      font-family: "IBM Plex Mono", Consolas, monospace;
      font-variant-numeric: tabular-nums;
    }
    .charts {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    .chart-card {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 8px;
      background: rgba(255, 255, 255, 0.02);
    }
    .chart-title {
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    canvas {
      width: 100%;
      height: 140px;
      display: block;
      border-radius: 8px;
      background: #0b121a;
      border: 1px solid #1f2c3c;
    }
    .table-wrap {
      max-height: 460px;
      overflow: auto;
      border: 1px solid var(--line);
      border-radius: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      min-width: 980px;
    }
    thead th {
      position: sticky;
      top: 0;
      background: #0f1a25;
      color: var(--muted);
      text-align: left;
      padding: 9px;
      border-bottom: 1px solid var(--line);
    }
    tbody td {
      padding: 8px 9px;
      border-bottom: 1px solid #1f2b39;
      white-space: nowrap;
      font-variant-numeric: tabular-nums;
    }
    tbody tr:hover { background: rgba(87, 183, 255, 0.1); }
    .trade { color: var(--up); font-weight: 650; }
    .quote { color: var(--mid); font-weight: 650; }
    .diff-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .diff-box {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.02);
    }
    .ok { color: var(--up); font-weight: 650; }
    .bad { color: var(--down); font-weight: 650; }
    pre {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-word;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
    }
    @media (max-width: 1200px) {
      .stats { grid-template-columns: repeat(3, minmax(0, 1fr)); }
      .grid { grid-template-columns: 1fr; }
      .controls { grid-template-columns: 1fr 1fr; }
      .play { grid-template-columns: 1fr 1fr; }
      .diff-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <main class="app">
    <header>
      <h1 class="title">md-replay dashboard</h1>
      <div class="sub mono" id="sourceLine">loading...</div>
    </header>

    <section class="panel stats">
      <div class="stat"><div class="label">Events</div><div class="value mono" id="eventsCount">0</div></div>
      <div class="stat"><div class="label">Trades</div><div class="value mono" id="tradesCount">0</div></div>
      <div class="stat"><div class="label">Quotes</div><div class="value mono" id="quotesCount">0</div></div>
      <div class="stat"><div class="label">Symbols</div><div class="value mono" id="symbolCount">0</div></div>
      <div class="stat"><div class="label">Cursor Seq</div><div class="value mono" id="cursorSeq">0</div></div>
      <div class="stat"><div class="label">Playback</div><div class="value mono" id="playState">idle</div></div>
    </section>

    <section class="panel">
      <div class="controls">
        <div class="field">
          <label for="symbol">Symbol</label>
          <select id="symbol"><option value="">All</option></select>
        </div>
        <div class="field">
          <label for="fromSeq">From Seq</label>
          <input id="fromSeq" type="number" min="1" placeholder="auto" />
        </div>
        <div class="field">
          <label for="toSeq">To Seq</label>
          <input id="toSeq" type="number" min="1" placeholder="auto" />
        </div>
        <div class="field">
          <label for="rows">Rows</label>
          <input id="rows" type="number" min="1" max="100000" value="3000" />
        </div>
        <button id="reload">Load Data</button>
      </div>
      <div class="play">
        <button id="playBtn">Play</button>
        <button id="pauseBtn" class="alt">Pause</button>
        <button id="stepBtn" class="alt">Step</button>
        <button id="resetBtn" class="warn">Reset</button>
        <div class="field">
          <label for="speed">Speed (x)</label>
          <input id="speed" type="number" min="0.1" step="0.1" value="10" />
        </div>
        <div class="field">
          <label for="tail">Table Tail Rows</label>
          <input id="tail" type="number" min="20" max="1000" value="200" />
        </div>
      </div>
    </section>

    <section class="grid">
      <section class="panel charts">
        <div class="chart-card">
          <div class="chart-title">Midprice + Signals</div>
          <canvas id="midChart"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title">Spread</div>
          <canvas id="spreadChart"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title">Imbalance / Volatility</div>
          <canvas id="imbChart"></canvas>
        </div>
      </section>

      <section class="panel">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Seq</th>
                <th>Timestamp (ns)</th>
                <th>Venue</th>
                <th>Symbol</th>
                <th>Type</th>
                <th>Trade Px</th>
                <th>Trade Sz</th>
                <th>Bid Px</th>
                <th>Bid Sz</th>
                <th>Ask Px</th>
                <th>Ask Sz</th>
              </tr>
            </thead>
            <tbody id="eventsBody"></tbody>
          </table>
        </div>
      </section>
    </section>

    <section class="panel">
      <div class="diff-grid">
        <div class="diff-box">
          <div class="label">Determinism Check</div>
          <div id="detSummary" class="mono">-</div>
        </div>
        <div class="diff-box">
          <div class="label">Parser Regression Check</div>
          <div id="parseSummary" class="mono">-</div>
        </div>
      </div>
      <div class="diff-box" style="margin-top:10px;">
        <div class="label">First Mismatch</div>
        <pre id="mismatchBox">none</pre>
      </div>
    </section>
  </main>

  <script>
    const fmt = new Intl.NumberFormat("en-US");
    const $ = (id) => document.getElementById(id);
    const state = {
      rows: [],
      series: [],
      cursor: 0,
      playing: false,
      speed: 10,
      raf: 0,
      wallBase: 0,
      tsBase: 0
    };

    function esc(text) {
      return String(text)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    async function getJson(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`${url} failed`);
      return res.json();
    }

    function buildQuery() {
      const q = new URLSearchParams();
      const symbol = $("symbol").value.trim();
      const fromSeq = $("fromSeq").value.trim();
      const toSeq = $("toSeq").value.trim();
      const rows = $("rows").value.trim();
      if (symbol) q.set("symbol", symbol);
      if (fromSeq) q.set("from_seq", fromSeq);
      if (toSeq) q.set("to_seq", toSeq);
      if (rows) q.set("limit", rows);
      return q.toString();
    }

    async function loadMeta() {
      const meta = await getJson("/api/meta");
      $("eventsCount").textContent = fmt.format(meta.events);
      $("tradesCount").textContent = fmt.format(meta.trades);
      $("quotesCount").textContent = fmt.format(meta.quotes);
      $("symbolCount").textContent = fmt.format(meta.symbols.length);
      $("sourceLine").textContent =
        `seq ${meta.first_sequence}..${meta.last_sequence} | ts ${meta.first_timestamp_ns}..${meta.last_timestamp_ns}`;

      const sel = $("symbol");
      while (sel.options.length > 1) sel.remove(1);
      for (const sym of meta.symbols) {
        const opt = document.createElement("option");
        opt.value = sym;
        opt.textContent = sym;
        sel.appendChild(opt);
      }
      if (meta.symbols.length > 0 && !sel.value) {
        sel.value = meta.symbols[0];
      }
    }

    async function loadData() {
      pausePlayback();
      const q = buildQuery();
      const suffix = q ? `?${q}` : "";
      const [events, series, diff] = await Promise.all([
        getJson(`/api/events${suffix}`),
        getJson(`/api/series${suffix}`),
        getJson(`/api/diff${suffix}`)
      ]);

      state.rows = events.rows || [];
      state.series = series || [];
      state.cursor = Math.min(state.rows.length, 50);
      state.speed = Number($("speed").value) || 10;

      renderDiff(diff);
      renderAll();
    }

    function renderDiff(diff) {
      const det = diff.determinism;
      const detStatus = det.ok ? '<span class="ok">PASS</span>' : '<span class="bad">FAIL</span>';
      $("detSummary").innerHTML =
        `${detStatus} | lines=${fmt.format(det.lines)} | first_mismatch=${det.first_mismatch_line ?? "none"}`;

      if (!diff.parser) {
        $("parseSummary").innerHTML = '<span class="mono">no compare log configured</span>';
        $("mismatchBox").textContent = "none";
        return;
      }

      const p = diff.parser;
      const pStatus = p.ok ? '<span class="ok">PASS</span>' : '<span class="bad">FAIL</span>';
      $("parseSummary").innerHTML =
        `${pStatus} | left=${fmt.format(p.left_events)} right=${fmt.format(p.right_events)} matched_prefix=${fmt.format(p.matched_prefix)}`;

      if (!p.first_mismatch) {
        $("mismatchBox").textContent = "none";
        return;
      }

      const m = p.first_mismatch;
      $("mismatchBox").innerHTML =
        `index=${m.index}\nreason=${esc(m.reason)}\nleft_seq=${m.left_sequence ?? "none"}\nright_seq=${m.right_sequence ?? "none"}\n\nleft=${esc(m.left_line ?? "none")}\nright=${esc(m.right_line ?? "none")}`;
    }

    function playPlayback() {
      if (state.playing || !state.series.length) return;
      if (state.cursor >= state.series.length) state.cursor = 0;
      state.playing = true;
      $("playState").textContent = "playing";
      anchorPlayback();
      state.raf = requestAnimationFrame(tickPlayback);
    }

    function anchorPlayback() {
      const i = Math.max(0, state.cursor - 1);
      state.wallBase = performance.now();
      state.tsBase = state.series[i]?.timestamp_ns ?? state.series[0]?.timestamp_ns ?? 0;
    }

    function pausePlayback() {
      if (!state.playing) return;
      state.playing = false;
      $("playState").textContent = "paused";
      if (state.raf) cancelAnimationFrame(state.raf);
      state.raf = 0;
    }

    function stepPlayback() {
      pausePlayback();
      if (state.cursor < state.series.length) {
        state.cursor += 1;
        renderAll();
      }
    }

    function resetPlayback() {
      pausePlayback();
      state.cursor = 0;
      $("playState").textContent = "paused";
      renderAll();
    }

    function tickPlayback(now) {
      if (!state.playing) return;
      const speed = Math.max(0.1, Number($("speed").value) || 1);
      const elapsedNs = (now - state.wallBase) * 1_000_000 * speed;
      const targetTs = state.tsBase + elapsedNs;

      let i = state.cursor;
      while (i < state.series.length && state.series[i].timestamp_ns <= targetTs) {
        i += 1;
      }
      if (i !== state.cursor) {
        state.cursor = i;
        renderAll();
      }
      if (state.cursor >= state.series.length) {
        state.playing = false;
        $("playState").textContent = "done";
        return;
      }
      state.raf = requestAnimationFrame(tickPlayback);
    }

    function renderAll() {
      renderTable();
      renderStats();
      renderCharts();
    }

    function renderStats() {
      const seq = state.rows[state.cursor - 1]?.sequence ?? 0;
      $("cursorSeq").textContent = fmt.format(seq);
      if (!state.playing && $("playState").textContent === "playing") {
        $("playState").textContent = "paused";
      }
      if (!state.playing && $("playState").textContent === "idle" && state.cursor > 0) {
        $("playState").textContent = "paused";
      }
    }

    function renderTable() {
      const body = $("eventsBody");
      const tail = Math.max(20, Math.min(1000, Number($("tail").value) || 200));
      const from = Math.max(0, state.cursor - tail);
      const visible = state.rows.slice(from, state.cursor);

      body.innerHTML = visible.map((row) => `
        <tr>
          <td class="mono">${fmt.format(row.sequence)}</td>
          <td class="mono">${row.timestamp_ns}</td>
          <td>${esc(row.venue)}</td>
          <td class="mono">${esc(row.symbol)}</td>
          <td class="${row.kind === "trade" ? "trade" : "quote"}">${row.kind}</td>
          <td class="mono">${row.price_ticks ?? ""}</td>
          <td class="mono">${row.size ?? ""}</td>
          <td class="mono">${row.bid_px ?? ""}</td>
          <td class="mono">${row.bid_sz ?? ""}</td>
          <td class="mono">${row.ask_px ?? ""}</td>
          <td class="mono">${row.ask_sz ?? ""}</td>
        </tr>
      `).join("");
    }

    function renderCharts() {
      const points = state.series.slice(0, state.cursor);
      drawLineChart($("midChart"), points, (p) => p.mid, getCss("--mid"), true);
      drawLineChart($("spreadChart"), points, (p) => p.spread, getCss("--spread"), false);
      drawDualChart(
        $("imbChart"),
        points,
        (p) => p.imbalance,
        getCss("--imb"),
        (p) => p.vol,
        getCss("--vol")
      );
      drawSignals($("midChart"), points);
    }

    function getCss(name) {
      return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    }

    function setupCanvas(canvas) {
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      const w = Math.max(10, Math.floor(rect.width * dpr));
      const h = Math.max(10, Math.floor(rect.height * dpr));
      if (canvas.width !== w || canvas.height !== h) {
        canvas.width = w;
        canvas.height = h;
      }
      const ctx = canvas.getContext("2d");
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      return { ctx, w, h, dpr };
    }

    function drawLineChart(canvas, points, valueOf, color, centerLine) {
      const { ctx, w, h } = setupCanvas(canvas);
      ctx.clearRect(0, 0, w, h);
      if (!points.length) return;

      const vals = points.map(valueOf).filter((v) => Number.isFinite(v));
      if (!vals.length) return;
      let min = Math.min(...vals);
      let max = Math.max(...vals);
      if (min === max) {
        min -= 1;
        max += 1;
      }

      ctx.strokeStyle = "#1c2a3a";
      ctx.lineWidth = 1;
      for (let i = 1; i <= 3; i++) {
        const y = (h * i) / 4;
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(w, y);
        ctx.stroke();
      }

      if (centerLine) {
        const y = mapY((min + max) * 0.5, min, max, h);
        ctx.strokeStyle = "#2a425c";
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(w, y);
        ctx.stroke();
      }

      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      points.forEach((p, i) => {
        const x = (i / Math.max(1, points.length - 1)) * (w - 1);
        const y = mapY(valueOf(p), min, max, h);
        if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
      });
      ctx.stroke();
    }

    function drawDualChart(canvas, points, leftOf, leftColor, rightOf, rightColor) {
      const { ctx, w, h } = setupCanvas(canvas);
      ctx.clearRect(0, 0, w, h);
      if (!points.length) return;

      const leftVals = points.map(leftOf).filter((v) => Number.isFinite(v));
      const rightVals = points.map(rightOf).filter((v) => Number.isFinite(v));
      if (!leftVals.length || !rightVals.length) return;
      const leftMin = Math.min(...leftVals);
      const leftMax = Math.max(...leftVals);
      const rightMin = Math.min(...rightVals);
      const rightMax = Math.max(...rightVals);

      ctx.strokeStyle = "#1c2a3a";
      ctx.lineWidth = 1;
      for (let i = 1; i <= 3; i++) {
        const y = (h * i) / 4;
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(w, y);
        ctx.stroke();
      }

      ctx.strokeStyle = leftColor;
      ctx.lineWidth = 2;
      ctx.beginPath();
      points.forEach((p, i) => {
        const x = (i / Math.max(1, points.length - 1)) * (w - 1);
        const y = mapY(leftOf(p), leftMin === leftMax ? leftMin - 1 : leftMin, leftMin === leftMax ? leftMax + 1 : leftMax, h);
        if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
      });
      ctx.stroke();

      ctx.strokeStyle = rightColor;
      ctx.lineWidth = 2;
      ctx.beginPath();
      points.forEach((p, i) => {
        const x = (i / Math.max(1, points.length - 1)) * (w - 1);
        const y = mapY(rightOf(p), rightMin === rightMax ? rightMin - 1 : rightMin, rightMin === rightMax ? rightMax + 1 : rightMax, h);
        if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
      });
      ctx.stroke();
    }

    function drawSignals(canvas, points) {
      const { ctx, w, h } = setupCanvas(canvas);
      if (!points.length) return;
      const marks = points
        .map((p, i) => ({ i, s: p.signal }))
        .filter((x) => x.s);
      ctx.fillStyle = "#ff6a6a";
      for (const m of marks) {
        const x = (m.i / Math.max(1, points.length - 1)) * (w - 1);
        ctx.fillRect(x - 1, h - 12, 2, 10);
      }
    }

    function mapY(value, min, max, h) {
      const t = (value - min) / (max - min);
      return (1 - t) * (h - 8) + 4;
    }

    function wire() {
      $("reload").addEventListener("click", async () => {
        await loadData();
      });
      $("playBtn").addEventListener("click", playPlayback);
      $("pauseBtn").addEventListener("click", pausePlayback);
      $("stepBtn").addEventListener("click", stepPlayback);
      $("resetBtn").addEventListener("click", resetPlayback);
      $("speed").addEventListener("change", () => {
        state.speed = Math.max(0.1, Number($("speed").value) || 1);
        if (state.playing) anchorPlayback();
      });
      window.addEventListener("resize", () => renderCharts());
    }

    async function boot() {
      wire();
      await loadMeta();
      await loadData();
      $("playState").textContent = "paused";
    }

    boot().catch((e) => {
      $("sourceLine").textContent = `error: ${e.message}`;
    });
  </script>
</body>
</html>
